---
- name: Install prerequisites for Node.js
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present

- name: Download NodeSource setup script
  get_url:
    url: "{{ nodesource_repo_url }}"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'

- name: Run NodeSource setup script
  command: bash /tmp/nodesource_setup.sh
  args:
    creates: /etc/apt/sources.list.d/nodesource.list
  register: nodesource_setup

- name: Update apt cache after adding NodeSource repo
  apt:
    update_cache: yes
  when: nodesource_setup.changed

- name: Install Node.js
  apt:
    name: nodejs
    state: present

- name: Check current npm version
  command: npm --version
  register: npm_current_version
  changed_when: false
  failed_when: false

- name: Check if npm upgrade is needed
  set_fact:
    npm_upgrade_needed: "{{ npm_current_version.stdout.split('.')[0] | int < npm_version | int }}"
  when: npm_current_version.rc == 0

- name: Upgrade npm to version {{ npm_version }}
  command: npm install -g npm@{{ npm_version }}
  when:
    - npm_current_version.rc == 0
    - npm_upgrade_needed | default(false)

- name: Install npm if not present
  command: npm install -g npm@{{ npm_version }}
  when: npm_current_version.rc != 0

- name: Install global npm packages
  npm:
    name: "{{ item }}"
    global: yes
    state: present
  loop: "{{ nodejs_global_packages }}"
  when: nodejs_global_packages | length > 0

- name: Verify Node.js installation
  command: node --version
  register: node_version
  changed_when: false

- name: Verify npm installation
  command: npm --version
  register: npm_version_check
  changed_when: false

- name: Verify PM2 installation
  command: pm2 --version
  register: pm2_version
  changed_when: false
  failed_when: false
  when: pm2_install | bool

- name: Display installed versions
  debug:
    msg:
      - "Node.js: {{ node_version.stdout }}"
      - "npm: {{ npm_version_check.stdout }}"
      - "PM2: {{ pm2_version.stdout | default('Not installed') }}"
